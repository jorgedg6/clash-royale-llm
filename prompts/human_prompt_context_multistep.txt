<Prompt>
  <Inputs>
    <Variable name="CARTAS_DISPONIBLES" type="array[string]">
      $CARTAS_DISPONIBLES%
    </Variable>
    <Variable name="CARTAS_SELECCIONADAS" type="array[string]">
      $CARTAS_SELECCIONADAS%
    </Variable>
  </Inputs>

  <Context>
    $TOP_DECKS%
  </Context>

  <Task>
    Dado CARTAS_DISPONIBLES y CARTAS_SELECCIONADAS, selecciona las mejores
    (8 - |CARTAS_SELECCIONADAS|) cartas en ORDEN DE PRIORIDAD para completar el mazo a 8.
    Si |CARTAS_SELECCIONADAS| == 8, devuelve una selección vacía.
    
    Debes trabajar esta tarea en MÚLTIPLES PASOS:
    1. SELECCIÓN INICIAL: Realiza tu primera selección de cartas
    2. REVISIÓN Y VERIFICACIÓN: Revisa críticamente tu selección
    3. REFINAMIENTO: Corrige cualquier problema encontrado durante la revisión
  </Task>

  <Constraints>
    <Rule>No propongas cartas fuera de CARTAS_DISPONIBLES.</Rule>
    <Rule>No repitas cartas que ya estan en CARTAS_SELECCIONADAS.</Rule>
    <Rule>El mazo final debe tener exactamente 8 cartas en total, ni mas ni menos.</Rule>
    <Rule>Devuelve en el JSON solamente las cartas nuevas que seleccionaste.</Rule>
    <Rule>Evita redundancias funcionales claras (p. ej., múltiples hechizos o edificios con rol idéntico sin justificación).</Rule>
    <Rule>Favorece sinergias con las cartas ya seleccionadas y cubre roles clave:
      condición de victoria, respuesta aérea/tierra, daño en área, reset/control, ciclo/soporte y tanqueo según el arquetipo que emerja.
    </Rule>
    <Rule>Optimiza el coste medio de elixir manteniéndolo razonable para el arquetipo detectado.</Rule>
  </Constraints>

  <MultiStepProcess>
    <Step number="1" name="SeleccionInicial">
      <Description>Realiza tu selección inicial de cartas basándote en las guías de razonamiento.</Description>
      <Actions>
        <Action>Identifica el arquetipo implícito en CARTAS_SELECCIONADAS.</Action>
        <Action>Detecta vacíos de rol y debilidades.</Action>
        <Action>Selecciona cartas que aborden estos vacíos manteniendo sinergia.</Action>
        <Action>Calcula el impacto esperado en el coste de elixir.</Action>
      </Actions>
      <Output>Documenta tu razonamiento inicial y selección en el campo "cadenaDeRazonamiento".</Output>
    </Step>

    <Step number="2" name="RevisionYVerificacion">
      <Description>Revisa críticamente tu selección inicial para verificar que tenga sentido.</Description>
      <Checklist>
        <Check>¿Están todas las cartas seleccionadas dentro de CARTAS_DISPONIBLES?</Check>
        <Check>¿Hay cartas duplicadas (con CARTAS_SELECCIONADAS o dentro de tu selección)?</Check>
        <Check>¿El mazo final tiene exactamente 8 cartas en total?</Check>
        <Check>¿Hay redundancias funcionales que necesiten justificación?</Check>
        <Check>¿Las cartas cubren adecuadamente roles clave (condición de victoria, anti-aéreo, hechizos, etc.)?</Check>
        <Check>¿El coste de elixir es razonable para el arquetipo?</Check>
        <Check>¿Hay mejores alternativas disponibles en CARTAS_DISPONIBLES?</Check>
        <Check>¿Las cartas funcionan bien juntas sinérgicamente?</Check>
      </Checklist>
      <Output>Documenta los hallazgos de tu revisión en el campo "revision", incluyendo cualquier problema identificado.</Output>
    </Step>

    <Step number="3" name="Refinamiento">
      <Description>Si se encontraron problemas en el Paso 2, corrígelos. Si no hay problemas, confirma la selección.</Description>
      <Actions>
        <Action>Si se encontraron problemas: Reemplaza cartas problemáticas con mejores alternativas de CARTAS_DISPONIBLES.</Action>
        <Action>Si no hay problemas: Confirma que la selección inicial es óptima.</Action>
        <Action>Re-verifica que la selección refinada cumple todas las restricciones.</Action>
      </Actions>
      <Output>Documenta cualquier cambio realizado y el razonamiento final en el campo "refinamiento".</Output>
    </Step>
  </MultiStepProcess>

  <ReasoningGuidelines>
    <Step>Identifica el arquetipo implícito en CARTAS_SELECCIONADAS (p. ej., ciclo, beatdown, control, bridge spam, bait).</Step>
    <Step>Detecta vacíos de rol y debilidades (p. ej., falta de anti-aéreo, ausencia de hechizo grande/pequeño, carencia de reset).</Step>
    <Step>Prioriza cartas que:
      <Criterion>Potencien la condición de victoria existente o añadan una complementaria si falta.</Criterion>
      <Criterion>Cubran amenazas comunes (enjambres, tanques, win-cons rápidas, aéreo).</Criterion>
      <Criterion>Mejoren matchups sinérgicos sin inflar demasiado el coste medio.</Criterion>
    </Step>
    <Step>Ordena la propuesta por aporte marginal esperado al mazo (1 = más valiosa).</Step>
  </ReasoningGuidelines>

  <OutputFormat>
    Devuelve únicamente un objeto JSON válido con este esquema:
    <![CDATA[
    {
      "seleccion": [ "<carta_1>", "<carta_2>", "... hasta N" ],
      "detalle": [
        {
          "carta": "<nombre>",
          "costo_elixir": "<costo_de_elixir>",
          "rol": "<rol_principal>",
          "sinergiasCon": ["<carta_existente_1>", "..."],
          "cubreDebilidad": ["<debilidad_1>", "..."],
          "impactoElixir": {"antes": <float>, "despues": <float>}
        }
      ],
      "resumen": "1-2 frases con el arquetipo final y el plan de juego",
      "n": <N>,  // N = 8 - |CARTAS_SELECCIONADAS|
      "cadenaDeRazonamiento": {
        "seleccionInicial": {
          "arquetipoIdentificado": "<arquetipo>",
          "vaciosDeRol": ["<vacio_1>", "<vacio_2>", "..."],
          "razonamiento": "Explicación detallada de por qué cada carta fue seleccionada inicialmente",
          "cartasIniciales": [ "<carta_1>", "<carta_2>", "..." ],
          "analisisElixir": "Análisis del impacto en el coste de elixir"
        },
        "revision": {
          "resultadosVerificacion": {
            "todasCartasDisponibles": <boolean>,
            "sinDuplicados": <boolean>,
            "conteoCorrecto": <boolean>,
            "sinRedundancias": <boolean>,
            "rolesCubiertos": <boolean>,
            "elixirRazonable": <boolean>,
            "verificacionSinergia": <boolean>
          },
          "problemasEncontrados": [
            {
              "problema": "<descripcion>",
              "severidad": "<critico|mayor|menor>",
              "cartasAfectadas": ["<carta_1>", "..."]
            }
          ],
          "notasRevision": "Evaluación general de la selección inicial"
        },
        "refinamiento": {
          "cambiosRealizados": <boolean>,
          "cartasReemplazadas": [
            {
              "removida": "<nombre_carta>",
              "razon": "<por_que_removida>",
              "reemplazadaPor": "<nombre_carta>",
              "razon": "<por_que_mejor>"
            }
          ],
          "razonamientoFinal": "Explicación de la selección final y por qué es óptima",
          "confianza": "<alta|media|baja>"
        }
      }
    }
    ]]>
  </OutputFormat>

  <EdgeCases>
    <Case name="MazoCompleto">
      Si |CARTAS_SELECCIONADAS| == 8, devuelve:
      <![CDATA[
      { 
        "seleccion": [], 
        "detalle": [], 
        "resumen": "El mazo ya tiene 8 cartas.", 
        "n": 0,
        "cadenaDeRazonamiento": {
          "seleccionInicial": {"razonamiento": "El mazo ya está completo."},
          "revision": {"resultadosVerificacion": {}, "problemasEncontrados": [], "notasRevision": "No se requiere acción."},
          "refinamiento": {"cambiosRealizados": false, "razonamientoFinal": "Mazo completo.", "confianza": "alta"}
        }
      }
      ]]> 
    </Case>
    <Case name="DisponibilidadInsuficiente">
      Si CARTAS_DISPONIBLES tiene menos de N cartas elegibles, devuelve tantas como sea posible y explica la limitación en "resumen" y "cadenaDeRazonamiento.refinamiento.razonamientoFinal".
    </Case>
    <Case name="ConflictoDeRoles">
      Si dos opciones compiten por el mismo slot funcional, prioriza la de mayor sinergia global y mejor curva; menciona la alternativa en "detalle" y documenta la decisión en "cadenaDeRazonamiento".
    </Case>
  </EdgeCases>

  <Examples>
    <Example title="Faltan 3 cartas">
      <Input>
        <![CDATA[
        CARTAS_SELECCIONADAS = ["Montapuercos","Mosketeer","Tronco","Cañón","Espíritu de Hielo"]
        CARTAS_DISPONIBLES   = ["Bola de Fuego","Terremoto","Esqueletos","Arqueras","Bárbaros de Élite"]
        ]]>
      </Input>
      <ExpectedOutputNote>
        Devuelve 3 cartas con cadena de razonamiento completa mostrando:
        - Razonamiento de selección inicial (identificando arquetipo de ciclo, necesidad de hechizo, etc.)
        - Hallazgos de revisión (verificando que todas las restricciones se cumplan)
        - Cualquier refinamiento realizado (si la selección inicial tenía problemas)
      </ExpectedOutputNote>
    </Example>
  </Examples>

  <Style>
    <Rule>Lenguaje conciso y técnico.</Rule>
    <Rule>Sé exhaustivo en la cadena de razonamiento - muestra tu proceso completo de razonamiento.</Rule>
    <Rule>No incluyas texto extra fuera del JSON especificado.</Rule>
  </Style>
</Prompt>

